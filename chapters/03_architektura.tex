\chapter{Architektura kódu}
Před zahájením implementace je důležité si rozmyslet a naplánovat architekturu kódu.
Dobře navržená architektura nám může ušetřit spoustu času a námahy v budoucnu, například při přidávání nových funkcí nebo opravování stávajícího kódu.
Zároveň přispívá ke zvýšení jeho čitelnosti a udržovatelnosti.
Naopak špatně navržená architektura může vést k problémům, jako je těžko udržovatelný kód, složitá rozšiřitelnost, náročné zjišťování chyb a celkově pomalejší vývoj.

Architektura aplikace byla navržena především s cílem jasně oddělit odpovědnosti jednotlivých částí kódu, čímž podporuje dosažení výše uvedených vlastností.
Při návrhu byly převzaty vybrané principy běžně používané v moderních architektonických přístupech, které jsou popsány v následujících podkapitolách.

V rámci této kapitoly je používán pojem \emph{doména aplikace}, kterým je v kontextu této práce myšlena oblast reálného světa, již aplikace modeluje a jejíž pravidla a procesy realizuje.
Doménová logika pak představuje část aplikační logiky odpovědnou za implementaci těchto pravidel, nezávisle na konkrétních technologiích či uživatelském rozhraní.
Toto pojetí vychází z principů doménově řízeného návrhu.\footfullcite{evans_ddd}


\section{Architektonický vzor MVVM}
Jako základní architektonický vzor byla zvolena architektura Model-View-ViewModel (MVVM).\footfullcite{mvvm}
Je to doporučený vzor pro vývoj nativních Android aplikací, který je podporován samotným Android Frameworkem a prosazován společností Google, která stojí za vývojem platformy Android.\footfullcite{android_recommended_architecture}
V navrhované aplikaci je architektonický vzor MVVM využit k jasnému oddělení odpovědností mezi uživatelským rozhraním, logikou obrazovek a doménovou logikou.
Vzor MVVM za tímto účelem rozděluje aplikaci do tří hlavních komponent: Model, View a ViewModel.

\textbf{View} představuje uživatelské rozhraní a je zodpovědné pouze za zobrazování dat a předávání uživatelských událostí.
V této aplikaci je View realizováno pomocí frameworku Jetpack Compose a neobsahuje žádnou aplikační ani doménovou logiku, jak je doporučeno v architektonickém vzoru MVVM\@.

\textbf{Model} reprezentuje data a doménovou logiku aplikace, včetně komunikace s repozitáři a datovými zdroji.
Podle MVVM nesmí být nijak závislý na uživatelském rozhraní ani jeho konkrétní implementaci a nesmí obsahovat logiku týkající se zobrazení.
V navrhované aplikaci tuto roli plní doménová vrstva, jejíž struktura a principy jsou podrobně popsány v sekci~\ref{sec:oddeleni-domenove-a-datove-vrstvy}.

\textbf{ViewModel} slouží jako prostředník mezi View a Modelem.
Je zodpovědný za správu stavu uživatelského rozhraní, reakci na uživatelské události a komunikaci s Modelem za účelem získání nebo aktualizace dat.

ViewModel obsahuje aktuální stav zobrazení a vystavuje ho ve formě, kterou může View snadno sledovat a reagovat na jeho změny.
V navrhované aplikaci jsou pro správu stavu obrazovek využívány asynchronní datové toky (Flow), do kterých při změně dat ViewModel publikuje nový stav jakožto neměnný (immutable\footfullcite{compose_ui_architecture}) objekt.
View pak tento stav pozoruje a na jeho základě vykresluje uživatelské rozhraní.
Naopak View zase předává uživatelské události ViewModelu, který na ně reaguje a případně aktualizuje stav nebo komunikuje s Modelem.
Tomuto přístupu se říká \textbf{jednosměrný tok dat} (unidirectional data flow\footfullcite{android_recommended_architecture}) a přispívá k lepší předvídatelnosti a stabilitě aplikace.

Ve ViewModelu se nachází pouze logika týkající se uživatelského rozhraní, ne však jeho samotné vykreslování.
Doménová logika a správa dat jsou plně odděleny v Modelu.
Stejně tak logika spojená s navigací mezi obrazovkami, zobrazení vyskakovacích oken či upozornění pro uživatele se nachází ve View, protože je závislá na konkrétní implementaci uživatelského rozhraní.

ViewModely v této aplikaci nevykonávají žádné přímé akce nad uživatelským rozhraním, ale vystavují takzvané \textbf{efekty} (side-effects\footfullcite{android_side_effect}).
Efekty jsou jednorázové události, které vyvolávají akce v uživatelském rozhraní, jako například právě zmíněná navigace nebo zobrazení vyskakovacích oken.
View vystavované efekty interpretuje a na jejich základě provádí příslušné akce v uživatelském rozhraní.

Jak bylo zmíněno výše, MVVM je přímo podporovaný Android Frameworkem.
ViewModely jsou v Android Frameworku takzvaně lifecycle-aware, což znamená, že automaticky reagují na změny životního cyklu aplikace, například při změně konfigurace zařízení (otočení obrazovky) nebo při přechodu aplikace na pozadí.
Díky tomu nedochází ke ztrátě stavu uživatelského rozhraní a k opakovanému načítání dat při těchto změnách.

Zvolený způsob využití architektonického vzoru MVVM se v praxi osvědčil jako přehledný a umožnil jasné oddělení uživatelského rozhraní od doménové logiky aplikace.


\section{Struktura projektu podle funkčních celků}
Projekt je strukturován podle funkčních celků (feature-based struktura), kdy jednotlivé části aplikace odpovídají konkrétním oblastem domény nebo uživatelské funkcionality.
Tento přístup umožňuje jasné oddělení odpovědností, lepší orientaci v kódu a omezuje provázanost mezi jednotlivými částmi aplikace.

Každý celek je v projektu organizován jako samostatná jednotka a typicky obsahuje následující vrstvy:
\begin{itemize}
    \item \textbf{domain} – doménové modely, use-case třídy a rozhraní repozitářů (viz sekce~\ref{sec:oddeleni-domenove-a-datove-vrstvy}),
    \item \textbf{data} – konkrétní implementace repozitářů a práce s datovými zdroji, mapování návratových hodnot do doménových výsledků (viz sekce~\ref{sec:domain_result}),
    \item \textbf{di} – definice závislostí a jejich konfigurace pro daný funkční celek,
    \item \textbf{sample} - ukázková data využívaná během testování a ladění aplikace.
\end{itemize}

Aplikace je rozdělena do několika hlavních funkčních celků.
Mezi nejdůležitější patří například:
\begin{itemize}
    \item \textbf{auth} – správa registrace a přihlášení uživatelů,
    \item \textbf{shop} – práce s obchody, jejich vytváření, úprava a zobrazování,
    \item \textbf{review} – hodnocení a recenze obchodů,
    \item \textbf{user} – správa uživatelských údajů,
    \item \textbf{core} – logika jádra aplikace, architektonické abstrakce,
    \item \textbf{common} – společné pomocné třídy a funkce.
\end{itemize}

Celek \textbf{shop} obsahuje především entitu \textit{Shop} a s ní související doménovou logiku.
Ta je realizovaná pomocí samostatných use-case tříd pro vytváření, úpravu a mazání obchodů a různé možnosti zobrazování obchodů (všechny obchody podle vzdálenosti, nejbližších X obchodů, obchody daného uživatele, \ldots).
K tomu tento celek obsahuje i zmiňované rozhraní repozitářů (v doménové vrstvě) a jejich implementace (v datové vrstvě) a ukázková data (v balíčku \textit{sample}) využívaná pro testování a náhled uživatelského rozhraní.

Celek \textbf{common} obsahuje sdílenou logiku, která není přímo spojená s konkrétní doménou, ale je využívána v různých částech aplikace.
Jedná se převážně o jednoduché bezstavové pomocné funkce a třídy.
Patří sem například třídy pro práci s barvou nebo logika pro formátování dat, validaci, porovnávání textů apod.

Celek \textbf{core} obsahuje logiku jádra aplikace, na které je závislá většina ostatních funkčních celků.
Patří sem například abstrakce dat z repozitářů a doménových chyb operací (viz sekce~\ref{sec:domain_result}) nebo obecná rozhraní využívaná napříč aplikací, jako je kontrakt pro perzistentní entity.
Tento celek není závislý na žádném jiném funkčním celku aplikace.
Většina ostatních funkčních celků je naopak závislá na tomto celku, čímž je zajištěno, že sdílená logika je centralizována a jednotná.

Uživatelské rozhraní je organizováno samostatně ve funkčním celku \textbf{app} v podsložce \textit{ui}, kde jsou jednotlivé prvky rozděleny podle obrazovek nebo samostatných částí uživatelského rozhraní (komponent).
Kromě toho složka ui obsahuje také podsložky \textbf{ui/common}, která obsahuje sdílené prvky uživatelského rozhraní, a \textbf{ui/core}, která obsahuje základní komponenty a centrální logiku pro práci s uživatelským rozhraním (navigace a navigační bar, vyvolávání vyskakovacích oken, informační lišty apod.).
Funkční celek \textbf{app} je jako jediný celek přímo závislý na platformě Android, zatímco ostatní funkční celky jsou nezávislé na konkrétní platformě a mohou být potenciálně znovu použity i v jiných typech aplikací.

Jednotlivé funkční celky jsou v projektu realizovány jako samostatné Gradle moduly, což přispívá k lepší izolaci závislostí a zkrácení doby sestavení projektu.


\section{Oddělení doménové a datové vrstvy}\label{sec:oddeleni-domenove-a-datove-vrstvy}
Jedním ze základních principů architektury aplikace je oddělení doménové a datové vrstvy.\footfullcite{domain_data_layer_separation}
Cílem tohoto rozdělení je zajistit, aby doménová logika aplikace nebyla závislá na konkrétní implementaci ukládání nebo získávání dat.

\textbf{Doménová vrstva} (domain layer) obsahuje veškerou logiku týkající se samotné domény aplikace.
To zahrnuje definice doménových modelů, use-case třídy a rozhraní repozitářů.
Doménové modely reprezentují klíčové entity domény aplikace, jako jsou například uživatelé, obchody nebo recenze.
Jedná se o čisté datové třídy bez závislostí na konkrétních technologiích nebo knihovnách a obsahují pouze atributy potřebné pro reprezentaci dané entity v kontextu domény aplikace.
V use-case třídách je konkrétní doménová logika implementována a představují hlavní vstupní bod pro její volání z ViewModelů.
Jedná se často o komplexní nebo znovupoužitelnou logiku, jako je například validace dat, doménová pravidla, výpočty, koordinace více operací nad daty, nebo jen jednoduché zprostředkování volání repozitářů.
Komunikace s backendem probíhá přes rozhraní repozitářů definovaných v doménové vrstvě.
Rozhraní repozitářů byla umístěna do této vrstvy, protože tvoří hranici mezi doménovou logikou a datovými zdroji a výsledky jejich operací jsou orientovány na doménové modely a chyby.

\textbf{Datová vrstva} (data layer) je zodpovědná za konkrétní implementaci repozitářů a práci s datovými zdroji, jako je například Firestore, Firebase Auth nebo Firebase Storage.
Datová vrstva obsahuje datové modely, které reprezentují strukturu dat v konkrétních datových zdrojích.
Datové modely se mohou lišit od doménových modelů, protože jsou přizpůsobeny specifickým požadavkům daného datového zdroje.
V datové vrstvě tak probíhá získávání a ukládání dat, mapování datových modelů na doménové modely a naopak, a zpracování technických chyb vznikajících při komunikaci s datovými zdroji.
Datová vrstva kromě základních operací zapouzdřuje také složitější způsoby práce s daty, které jsou závislé na konkrétním datovém zdroji, například stránkování výsledků nebo dotazy nad geografickými daty.

Díky definici rozhraní repozitářů v doménové vrstvě a jejich implementaci v datové vrstvě je závislost mezi těmito vrstvami jednosměrná a směřuje výhradně od doménové vrstvy k datové vrstvě.
Toto rozdělení umožňuje snadnou výměnu nebo úpravu datových zdrojů bez nutnosti měnit doménovou logiku aplikace.


\section{Zpracování výsledků a chyb v doménové vrstvě}\label{sec:domain_result}
% DomainResult a DomainError
% princip...
% výhody...

% Zdůrazni:
%  - návratová hodnota use-casů a repozitářů
%  - nutí volajícího explicitně řešit chyby


\section{Tok dat v aplikaci}

% příklad toku dat:
% 1. uživatelská akce v UI
% 2. ViewModel zpracuje událost
% 3. volání use-casu, doménová logika
% 4. volání repozitáře
% 5. výsledek jako DomainResult z repozitáře (respektive DomainError v případě chyby)
% 6. aktualizace StateFlow (respektive zpracování chyby)
% 7. UI se automaticky přerenderuje

% zmínit immutabilty princip?


\section{Vkládání závislostí (Dependency Injection)}
% Hilt
% výhody DI
%  - lepší testovatelnost
%  - méně kódu pro vytváření závislostí
%  - pro viewmodely, use-casy, repozitáře


\section{Shrnutí architektury}
% architektura odpovídá rozsahu bakalářské práce
% ověřena reálným provozem aplikace
% umožnila úspěšnou implementaci a publikaci aplikace
% zjednodušila vývoj, údržbu kódu, přidávání nových funkcí a opravy chyb
%
% "Zvolená architektura se v praxi osvědčila jako přehledná, rozšiřitelná a vhodná pro další rozvoj aplikace."
